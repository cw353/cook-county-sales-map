<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HEI Choropleth Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"></script>
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

  <!-- leaflet-chloropleth and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js" integrity="sha512-zInFF17qBFVvvvFpIfeBzo7Tj7+rQxLeTJDmbxjBz5/zIr89YVbTNelNhdTT+/DCrxoVzBeUPVFJsczKbB7sew==" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-choropleth@1.1.4/dist/choropleth.js" integrity="sha512-7wqXJ5fLDm47Tl7gRm/eoOCpAcfawcHxX64uE2kCGhgAGhTDqgTDZNXyuHxuy8F8dPjP4/PLB1/eobW6/gWZZw==" crossorigin="anonymous"></script>

  <!-- other Leaflet plugins -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.control.layers.tree@1.1.0/L.Control.Layers.Tree.css" integrity="sha512-ERJ24eirtxblVa8OFgLvEo5POXA4KjIH9dFD1RjXL0FbTr5PkpBYTnIMFGhhWdmGdXOUlxQhLu/S0BiPsbjAIA==" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet.control.layers.tree@1.1.0/L.Control.Layers.Tree.js" integrity="sha512-ETs9/6gyO86T5BWV+frzCctOVKzUa8CalhT+rCnm0AARnAAMX72vS6ifbFaeZr7BdxogolRqCS99XPbF2ltaqg==" crossorigin="anonymous"></script>  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-groupedlayercontrol@0.6.1/dist/leaflet.groupedlayercontrol.min.css" integrity="sha512-yP7tTm3rX87fOK3iDh9K2RJTHsq6BfGZ8sFqRMIfsmmZVakOw483WyOKlRWVLjHCHEDIcEkp/U+cO3TnZ8oiuw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.defaultextent@0.0.3/dist/leaflet.defaultextent.css" integrity="sha512-ov430Sdjmh6nk7i0pfdpzBiSi7KFhMC5oiO5eEB7YmzcmPCLJySjYdKu4DCRMVLsEGfP9eGx7NRyLgqykhuruA==" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet.defaultextent@0.0.3/dist/leaflet.defaultextent.js" integrity="sha512-msnSqRmMNIELIn0wnF4k9rY12rzfwi4Ak0CWgx0xr4WPF5x/oUMNV+m+/2UWJSobC5zKqngmtBeuCtcUxkeSlQ==" crossorigin="anonymous"></script>
  <script src="plugins/L.Control.Opacity/L.Control.Opacity.js"></script>

  <!-- data -->
  <script src="data/sales_data.js"></script>
  <script src="data/communities.js"></script>
  <script src="data/neighborhoods.js"></script>
  <script src="data/wards.js"></script>
  
  <style type="text/css">
    #map {
      height: 675px;
    }
    .italic {
      font-style: italic;
    }
    .leaflet-control {
      background: rgba(255,255,255,0.8);
    }
    .info {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
    }
    .info h4 {
      margin: 0 0 5px;
      color: #777;
      text-align: center;
    }
    .info p {
      text-align: center;
    }
    .legend {
      line-height: 18px;
      color: #555;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
      border-left: 1px solid black;
      border-right: 1px solid black;
    }
    .legend i:first-of-type {
      border-top: 1px solid black;
    }
    .legend br:first-of-type {
      line-height: 19px;
    }
    .legend i:last-of-type {
      border-bottom: 1px solid black;
    }
    .opacity-control-label {
      font: 14px/16px Arial, Helvetica, sans-serif;
      margin: 0 0 5px 0;
      color: #777;
      text-align: center;
      font-weight: bold;
    }
  </style>

</head>
<body>
    <div id="map"></div>
    <script>
      /*
       * references for code and styling:
       * https://github.com/timwis/leaflet-choropleth/blob/gh-pages/examples/fetch_join/demo.js (MIT license)
       * https://leafletjs.com/examples/choropleth/ (BSD 2-Clause "Simplified" License)
       */

      const map = new L.Map('map', {
        center: { lat: 41.813802, lng: -87.73819 },
        zoom: 9.5,
      });

      const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "<a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>",
      }).addTo(map);
      
      const usd_formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0,
      });
      const count_formatter = new Intl.NumberFormat('en-US');

      const numeric_value = function(value) {
        const parsed = parseFloat(value);
        return parsed;
      }
      const numeric_display = function(value, formatter) {
        return value ? formatter.format(value) : "unknown";
      }

      class Feature {
        constructor(label, get_value, display) {
          this.label = label;
          this.get_value = get_value;
          this.display = display;
        }
        getLabel() {
          return this.label;
        }
        getValue(val) {
          return this.get_value(val);
        }
        display(val) {
          return this.get_display(val);
        }
      }
      class USDFeature extends Feature {
        constructor(label) {
          super(label, numeric_value, (val) => numeric_display(val, usd_formatter));
        }
      }
      class CountFeature extends Feature {
        constructor(label) {
          super(label, numeric_value, (val) => numeric_display(val, count_formatter));
        }
      }

      const saleFeatures = {
        "mean": new USDFeature("Average Sale Price"),
        "median": new USDFeature("Median Sale Price"),
        "count": new CountFeature("Number of Sales"),
      }

      const geojson = {
        "By Assessor Neighborhood": { geojson: neighborhoods, key: "nbhd_code", keyLabel: "Assessor Neighborhood" },
        "By Community Area": { geojson: communities, key: "community", keyLabel: "Community Area" },
        "By Ward": { geojson: wards, key: "ward", keyLabel: "Ward" },
      };

      const legend = L.control({position: "bottomleft"});
      legend.onAdd = function (map) {
        this._div = L.DomUtil.create("div", "info legend");
        this.update();
        return this._div;
      }
      legend.update = function(colors = null, labels = null, title = "Legend") {
        if (colors == null || labels == null || colors.length !== labels.length) {
          this._div.innerHTML = "";
        } else {
          this._div.innerHTML = `<h4>${title}</h4>`;
          for (let i = 0; i < colors.length; i++) {
            this._div.innerHTML += `<i style="background: ${colors[i]}"></i> ${labels[i]}<br>`;
          }
        }
      };
      legend.addTo(map);
      // Precondition: the data represented in the choropleth is in integer format
      // (to allow truncation without loss of accuracy)
      function updateChoroplethLegend(colors, limits, title, display = null) {
        const labels = ["unknown"];
        for (let i = 0; i < limits.length; i++) {
          let label = "";
          if (i > 0) {
            label += (display ? display(Math.trunc(limits[i-1])+1) : Math.trunc(limits[i-1])+1) + "&ndash; ";
          } else {
            label += "&le; "
          }
          label += display ? display(Math.trunc(limits[i])) : Math.trunc(limits[i]);
          labels.push(label);
        }
        legend.update([null].concat(colors), labels, title);
      }
      
      const info = L.control({position: "topright"});
      info.onAdd = function (map) {
        this._div = L.DomUtil.create("div", "info");
        this.update();
        return this._div;
      };
      function get_info(data, attributes, summary) {
        const items = [];
        for (attr in attributes) {
          const label = summary ? ("Overall " + attributes[attr].getLabel()) : attributes[attr].getLabel();
          items.push(`<b>${label}</b>: ${attributes[attr].display(data ? data[attr] : null)}`);
        }
        return items.join("<br>");
      }
      info.update = function(title, data, attributes, summary=false) {
        this._div.innerHTML = `<h4>${title}</h4>`;
        this._div.innerHTML += get_info(data, attributes, summary);
        if (summary) {
          this._div.innerHTML += "<p class='italic'>Hover over an area to see details.</p>";
        }
      };

      const initialFillOpacity = 0.7;
      function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({
          weight: 5,
          color: '#666',
        });
        layer.bringToFront();
      }
      function resetHighlight(e) {
        e.target.setStyle({
          color: '#fff',
          weight: 2,
        });
      }
      function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
      }

      function createChoropleth(boundary, data, attributeName, attributes) {
        const choroplethLayer = L.choropleth(boundary.geojson, {
          valueProperty: function (feature) {
            const key = feature.properties[boundary.key];
            return data[key] ? data[key][attributeName] : NaN;
          },
          scale: "viridis",
          steps: 11,
          mode: 'q',
          style: {
            color: '#fff',
            weight: 2,
            fillOpacity: initialFillOpacity,
          },
        });
        const summarize = function() {
          info.update(`${boundary.keyLabel} Summary`, data["total"], attributes, true);
        }
        choroplethLayer.eachLayer(function (layer) {
          const key = layer.feature.properties[boundary.key];
          layer.on({
            mouseover: function(e) {
              highlightFeature(e);
              info.update(`${boundary.keyLabel} ${key}`, data[key], attributes);
            },
            mouseout: function(e) {
              resetHighlight(e);
              summarize();
            },
            click: zoomToFeature
          });
        });
        choroplethLayer.on({
          add: function() {
            summarize();
            updateChoroplethLegend(choroplethLayer.options.colors, choroplethLayer.options.limits, attributes[attributeName].getLabel(), attributes[attributeName].display);
          }
        });
        return choroplethLayer;
      }

      function populateChoropleths(obj, choroplethList) {
        if ("_data" in obj) {
          obj.children = [];
          for (attribute in child._attr) {
            const layer = createChoropleth(geojson[obj.label], obj._data, attribute, child._attr);
            choroplethList.push(layer);
            obj.children.push(
              {
                label: child._attr[attribute].getLabel(),
                layer: layer,
                radioGroup: "choropleth",
              });
          }
        } else if ("children" in obj) {
          for (child of obj.children) {
            populateChoropleths(child, choroplethList);
          }
        }
      }

      const overlays = [
        {
          label: "Recent Sale Prices for Major Class 2",
          children: [
            { label: "By Assessor Neighborhood",  _data: sales_by_nbhd, _attr: saleFeatures },
            { label: "By Community Area", _data: sales_by_community, _attr: saleFeatures },
            { label: "By Ward", _data: sales_by_ward, _attr: saleFeatures },
          ]
        }
      ];

      const choroplethList = [];
      for (overlay of overlays) {
        populateChoropleths(overlay, choroplethList);
      }

      const layerControlTree = L.control.layers.tree(
        [ {label: "OpenStreetMap", layer: osmtiles }],
        overlays,
        {
          collapsed: false,
          hideSingleBase: true,
        }
      ).addTo(map);

      L.control.defaultExtent().addTo(map);

      info.addTo(map);

      L.control
        .opacity(
          { "<div class='opacity-control-label'>Layer Opacity</div>" : L.layerGroup(choroplethList) },
          {
            position: "bottomright",
            initialOpacity: initialFillOpacity,
            updateOpacity: function(group, opacity) {
              group.eachLayer(function(layer) {
                layer.setStyle({ opacity: opacity, fillOpacity: opacity });
              });
            }
          },
        )
        .addTo(map);

        choroplethList[0].addTo(map);

  </script>

</body>
</html>
