<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cook County Sales Map</title>
  <meta name="author" content="Claire Wagner (Summer 2023 Wheaton College Research Team)">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"></script>
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

  <!-- Leaflet plugins -->
  <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.24.3/dist/plotly-basic.min.js" integrity="sha512-Qim/xu0OSUPEvOUcNVZoGTDa+m4Ll1EZ+DQhsmMTlMZIj7NxvwQl6pGY0/gwlj19w0KEZ0S8ymSWUpqarPYGBQ==" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.control.resizer@0.0.1/L.Control.Resizer.css" integrity="sha512-89rME2doVsjKo1HDC+av4LHfqH2mFhXU5DUM71HT8/re8KxZe1EZf86+mDbhD3kIpaS0zVs0nKBZQIOIb/Xowg==" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet.control.resizer@0.0.1/L.Control.Resizer.js" integrity="sha512-Yn7exzYqwK1hTlIWRvrCDS91kynaxb7/WR55buxeUdZp/DW9KHflTvkhxr3N0OcWoSaH/6ZBlV3PoVoghnho1A==" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" integrity="sha512-+uXbfI7GqghCnQUzxdA4P2cOwH00xc9s5gN551DUHWugGG1kOITswJniBDX4fQecqtWSoDUoJ4s1igb53PGENQ==" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" integrity="sha512-qh/P3G5pJ41NomJU64K7iqtrGpjd1odJapzykgv3Ch5pHc0ecjZahh4huIsmvTPXDRwvI86mqh2AbbLwZRS8Cw==" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.defaultextent@0.0.3/dist/leaflet.defaultextent.css" integrity="sha512-ov430Sdjmh6nk7i0pfdpzBiSi7KFhMC5oiO5eEB7YmzcmPCLJySjYdKu4DCRMVLsEGfP9eGx7NRyLgqykhuruA==" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet.defaultextent@0.0.3/dist/leaflet.defaultextent.js" integrity="sha512-msnSqRmMNIELIn0wnF4k9rY12rzfwi4Ak0CWgx0xr4WPF5x/oUMNV+m+/2UWJSobC5zKqngmtBeuCtcUxkeSlQ==" crossorigin="anonymous"></script>
  <script src="plugins/timeline-slider/leaflet-timeline-slider.min.js"></script>
  <script src="plugins/opacity/L.Control.Opacity.js"></script>

  <!-- Other dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js" integrity="sha512-zInFF17qBFVvvvFpIfeBzo7Tj7+rQxLeTJDmbxjBz5/zIr89YVbTNelNhdTT+/DCrxoVzBeUPVFJsczKbB7sew==" crossorigin="anonymous"></script>

  <!-- Data -->
  <script src="data/sales.js"></script>
  <script src="data/neighborhoods.js"></script>

  <style type="text/css">
    /* Portions of these styles are based on https://leafletjs.com/examples/choropleth/ (BSD 2-Clause "Simplified" License) */
    #map {
      height: 675px;
      max-width: 100%;
    }
    a.external::after {
      /* Source: Wikimedia Commons, https://commons.wikimedia.org/wiki/File:Link-external-small-ltr-progressive.svg (CC BY 4.0) */
      content: url(https://upload.wikimedia.org/wikipedia/commons/9/96/Link-external-small-ltr-progressive.svg);
      margin: 0px 0px 0px 5px;
    }
    label {
      margin-right: 5px;
    }
    .italic {
      font-style: italic;
    }
    #map .leaflet-control-attribution {
      margin-right: 35px;
    }
    #map .leaflet-control-resizer {
      background: rgba(224, 148, 49, 0.6);
    }
    .custom-control, #map .leaflet-control-layers {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
    }
    .custom-control, #map .leaflet-control-layers, #map .control_container, #map .leaflet-control-geocoder {
      background: rgba(255,255,255,0.9);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      border: 2px solid rgba(0,0,0,0.2);
    }
    .custom-control h4, .opacity-control-label {
      margin: 0 0 5px;
      color: #555;
      text-align: center;
    }
    .opacity-control-label {
      font: 14px/16px Arial, Helvetica, sans-serif;
      font-weight: bold;
    }
    .info p {
      text-align: center;
    }
    .info p:last-of-type {
      margin-bottom: 3px;
    }
    .legend {
      line-height: 18px;
      color: #555;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
      border-left: 1px solid black;
      border-right: 1px solid black;
    }
    .legend i:first-of-type {
      border-top: 1px solid black;
    }
    .legend br:first-of-type {
      line-height: 19px;
    }
    .legend i:last-of-type {
      border-bottom: 1px solid black;
    }
    .data-select-div {
      margin-top: 10px;
      margin-bottom: 5px;
    }
    .graph {
      max-width: 350px;
    }
    #map .leaflet-control-geocoder-alternatives {
      max-height: 115px;
      overflow-y: scroll;
    }
    #map .modebar {
      top: 30px;
    }
  </style>

</head>
<body>
    <div id="map"></div>

    <script>

      const map = new L.Map('map', {
        center: { lat: 41.76388, lng: -87.74898 },
        zoom: 9.5,
        zoomDelta: 0.5,
        zoomSnap: 0.5,
        attributionControl: false,
      });
      L.control.attribution({position: "bottomright"})
        .addAttribution("&copy; <a href='https://github.com/cw353/'>Claire Wagner</a>")
        .addTo(map);

      const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "<a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>",
      }).addTo(map);
      
      const usd_formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0,
      });
      const count_formatter = new Intl.NumberFormat('en-US');

      const numeric_value = function(value) {
        const parsed = parseFloat(value);
        return parsed;
      }
      const numeric_display = function(value, formatter) {
        return value ? formatter.format(value) : "unknown";
      }

      class Feature {
        constructor(label, get_value, display, d3_format) {
          this.label = label;
          this.get_value = get_value;
          this.display = display;
          this.d3_format = d3_format;
        }
        getLabel() {
          return this.label;
        }
        getValue(val) {
          return this.get_value(val);
        }
        getD3Format() {
          return this.d3_format;
        }
        display(val) {
          return this.get_display(val);
        }
      }
      class USDFeature extends Feature {
        constructor(label) {
          super(label, numeric_value, (val) => numeric_display(val, usd_formatter), ":$,");
        }
      }
      class CountFeature extends Feature {
        constructor(label) {
          super(label, numeric_value, (val) => numeric_display(val, count_formatter), ":,");
        }
      }

      function getFeatureValue(props, data) {
        const featureKey = props.nbhd_code;
        const val = data[featureKey] && data[featureKey][state.year] ? data[featureKey][state.year][state.stat] : null;
        return state._statProps.getValue ? state._statProps.getValue(val) : val;
      }

      // Get colors and limits for a choropleth map
      /* Portions of this function are based on https://github.com/timwis/leaflet-choropleth (MIT License) */
      function getChoroplethProps(layer, data, getValue, options = null) {
        // overwrite default options with provided options (if any)
        const opts = Object.assign({
          mode: 'q', steps: 10, scale: 'viridis'
        }, options);
        const values = [];
        layer.eachLayer(function(sublayer) {
          values.push(getValue(sublayer.feature.properties, data));
        });
        const limits = chroma.limits(values, opts.mode, opts.steps);
        const colors = opts.colors && opts.colors.length === limits.length
          ? opts.colors
          : chroma.scale(opts.scale).colors(limits.length-1);
        return [limits, colors];
      }

      const propertyClasses = {
        2: { name: "Major Class 2", desc: "Residential, Non-Multi-Family" },
      };

      const saleStats = {
        mean: new USDFeature("Average Sale Price"),
        median: new USDFeature("Median Sale Price"),
        min: new USDFeature("Minimum Sale Price"),
        max: new USDFeature("Maximum Sale Price"),
        count: new CountFeature("Number of Sales"),
      };

      /* Portions of this control is based on https://leafletjs.com/examples/choropleth/ (BSD 2-Clause "Simplified" License) */
      const info = L.control({position: "topleft"});
      info.onAdd = function(map) {
        this._div = L.DomUtil.create("div", "custom-control info");
        L.DomEvent.disableClickPropagation(this._div);
        L.DomEvent.disableScrollPropagation(this._div);
        return this._div;
      };
      info.update = function() {
        // Add header
        this._div.innerHTML = state.featureKey == null ? "<h4>Summary of<br>All Assessor Neighborhoods</h4>" : `<h4>Details for<br>Assessor Neighborhood ${state.featureKey}</h4>`;
        // Add info about how to toggle view between summary of all areas and details of specific area
        if (state.featureKey == null) {
          this._div.innerHTML += "<p class='italic'>Click on an area to see details.</p>";
        } else {
          this._div.innerHTML += "<p class='italic'>Click on this area again to deselect it.</p>"
        }
        // Add data items
        const data = state.featureKey == null ? state.summaryData : state.choroplethData[state.featureKey];
        const items = [
          `<b>Year</b>: ${state.year}`,
          `<b>Property Class</b>: <a class='external' href='https://www.cookcountyassessor.com/form-document/codes-classification-property'>${state._propertyClassProps.name}</a>`
        ];
        for (const stat in saleStats) {
          const statProps = saleStats[stat];
          items.push(`<b>${statProps.getLabel()}</b>: ${statProps.display(data && data[state.year] ? data[state.year][stat] : null)}`);
        }
        this._div.innerHTML += items.join("<br>");
        // Add link to source data
        let query = `https://datacatalog.cookcountyil.gov/resource/wvhk-k5uv.json?$where=starts_with(class, '${state.propertyClass}') AND year=${state.year}`;
        if (state.featureKey != null) {
          query += ` AND nbhd_code='${state.featureKey}'`;
        }
        query += "&$limit=1000000000";
        this._div.innerHTML += `<p><a class='external' href="${query}">View source data</a></p>`;
      };

      const dataSelectControl = L.control({position: "topright"});
      dataSelectControl.onAdd = function(map) {
        this._div = L.DomUtil.create("div", "custom-control data-select");
        L.DomEvent.disableClickPropagation(this._div);
        L.DomEvent.disableScrollPropagation(this._div);
        const selectClass = $("<select id='select-class'></select>")
          .html(Object.entries(propertyClasses).map(function([propertyClass, props]) {
            return `<option value="${propertyClass}">${props.name} (${props.desc})</option>`;
          }));
        const selectStat = $("<select id='select-attr'></select>")
          .html(Object.entries(saleStats).map(function([stat, statProps]) {
            return `<option value="${stat}">${statProps.getLabel()}</option>`;
          }))
          .on("change", function(e) {
            updateState("stat", e.target.value);
          });
        $(this._div).append([
          "<h4>Select Data to Display</h4>",
          $("<div class='data-select-div'></div>").append([
            `<label for="select-attr">Select Property Class:</label>`,
            selectClass,
          ]),
          $("<div data-select-div></div>").append([
            `<label for="select-attr">Select Statistic:</label>`,
            selectStat,
          ]),
        ]);
        return this._div;
      }

      /* Portions of this control are based on https://leafletjs.com/examples/choropleth/ (BSD 2-Clause "Simplified" License) */
      const legend = L.control({position: "bottomleft"});
      legend.onAdd = function(map) {
        this._div = L.DomUtil.create("div", "custom-control legend");
        L.DomEvent.disableClickPropagation(this._div);
        L.DomEvent.disableScrollPropagation(this._div);
        return this._div;
      }
      legend.update = function(colors = null, labels = null, title = "Legend") {
        if (colors == null || labels == null || colors.length !== labels.length) {
          this._div.innerHTML = "";
        } else {
          this._div.innerHTML = `<h4>${title}</h4>`;
          for (let i = 0; i < colors.length; i++) {
            this._div.innerHTML += `<i style="background: ${colors[i]}"></i> ${labels[i]}<br>`;
          }
        }
      };

      const graphControl = L.control({position: "topright"});
      graphControl.onAdd = function (map) {
        this._container = L.DomUtil.create("div", "custom-control graph");
        this._scatterDiv = L.DomUtil.create("div", "graph-subdiv");
        this._container.appendChild(this._scatterDiv);
        this._initPlot();
        this.updateScatter();
        L.DomEvent.disableClickPropagation(this._container);
        L.DomEvent.disableScrollPropagation(this._container);
        return this._container;
      };
      graphControl._initPlot = function() {
        const trace = {
          x: [], y: state.years,
          hoverlabel: { align: "left" },
        };
        const layout = {
          width: 275, height: 225,
          margin: { b: 35, l: 50, r: 35, t: 35 },
          xaxis: { title: { text: "YEAR", font: { size: 11, }, standoff: 0, }, tickfont: { size: 10 }, dtick: 2, },
          yaxis: { title: { font: { size: 11, } }, tickfont: { size: 10 } },
          title: { font: { family: "Arial", size: 13, color: "#555" } },
          paper_bgcolor: 'rgba(255,255,255,0.8)',
          plot_bgcolor: 'rgba(255,255,255,0)',
          modebar: { orientation: 'v', remove: ["select2d", "lasso2d", ]},
        };
        Plotly.newPlot(this._scatterDiv,
          [trace],
          layout,
          {
            scrollZoom: true,
            displayModeBar: true,
            displaylogo: false,
            toImageButtonOptions: { filename: 'cook_county_sales_scatterplot' }
          }
        );
      }
      graphControl._updatePlot = function(div, data_props, layout_props) {
        Plotly.update(this._scatterDiv, data_props, layout_props);
      }
      graphControl.updateScatter = function() {
        const data = state.featureKey == null ? state.summaryData : state.choroplethData[state.featureKey];
        const scope = state.featureKey == null ? "All Assessor Neighborhoods" : `Assessor Neighborhood ${state.featureKey}`;
        const y = state.years.map(function(year) {
          return data && data[year] ? data[year][state.stat] : null;
        });
        const ylabel = state._statProps.getLabel();
        const data_props = {
          x: [state.years], y: [y],
          hovertemplate: `Year: %{x}<br>${ylabel}: %{y${state._statProps.getD3Format()}}<extra></extra>`,
        };
        const layout_props = {
          'yaxis.title.text': ylabel.toUpperCase(),
          'title.text': `<b>Sales of Major Class ${state.propertyClass} Properties for<br> ${scope}</b>`,
        };
        this._updatePlot(this._scatterDiv, data_props, layout_props);
      }

      const state = {
        layer: null,
        year: null,
        propertyClass: 2,
        _propertyClassProps: propertyClasses[2],
        featureKey: null,
        stat: "mean",
        _statProps: saleStats["mean"],
        choroplethData: sales_by_nbhd,
        summaryData: sales_totals,
        years: sales_years,
        _limits: null,
        _colors: null,
        opacity: 0.7,
      };
      const updateChoropleth = function() {
        // TODO: add caching for limits and colors?
        [state._limits, state._colors] = getChoroplethProps(state.layer, state.choroplethData, getFeatureValue);
        // update fill colors on map
        state.layer.setStyle(function(feature) {
          const val = getFeatureValue(feature.properties, state.choroplethData);
          let fillColor = null;
          if (val != null && !isNaN(val)) {
            for (let i = 0; i < state._limits.length-1; i++) {
              if (val <= state._limits[i+1]) {
                fillColor = state._colors[i];
                break;
              }
            }
          }
          return { fillColor: fillColor };
        });
      }
      const updateLegend = function() {
        // update legend
        const display_func = null;
        const labels = ["unknown"];
        for (let i = 0; i < state._colors.length; i++) {
          const lower_limit = i === 0 ? Math.trunc(state._limits[i]) : Math.trunc(state._limits[i]+1);
          const upper_limit = Math.trunc(state._limits[i+1]);
          const label = state._statProps.display(lower_limit) + " &ndash; " + state._statProps.display(upper_limit);
          labels.push(label);
        }
        legend.update([null].concat(state._colors), labels, state._statProps.getLabel());
      }

      // callbacks to be called when the corresponding prop in state is changed
      const stateCallbacks = {
        year: function(val) {
          updateChoropleth();
          updateLegend();
          info.update();
        },
        stat: function(val) {
          state._statProps = saleStats[val];
          updateChoropleth();
          updateLegend();
          info.update();
          graphControl.updateScatter();
        },
        featureKey: function(val) {
          info.update();
          graphControl.updateScatter();
        },
        opacity: function(val) { state.layer.setStyle( { opacity: val, fillOpacity: val } ); },
      }

      function updateState(prop, val) {
        state[prop] = val;
        // if a state callback for this prop exists, call it
        if (prop in stateCallbacks) {
          stateCallbacks[prop](val);
        }
      }

      /* This function is based on https://leafletjs.com/examples/choropleth/ (BSD 2-Clause "Simplified" License) */
      function highlightFeature(e) {
        e.target.setStyle({
          weight: 5,
          color: '#333',
        }).bringToFront();
      }

      const defaultStyle = {
        color: '#fff',
        weight: 2,
      };
      state.layer = L.geoJSON(
        neighborhoods,
        {
          attribution: "<a class='pad-right' href='https://datacatalog.cookcountyil.gov/d/wvhk-k5uv'>Cook County Assessor's Office</a>",
          style: Object.assign({opacity: state.opacity, fillOpacity: state.opacity}, defaultStyle),
        }
      ).addTo(map);
      state.layer.eachLayer(function (sublayer) {
        sublayer.on({
          click: function(e) {
            state.layer.setStyle(defaultStyle);
            const featureKey = sublayer.feature.properties.nbhd_code;
            if (state.featureKey !== featureKey) {
              // first click in a row selects this feature
              updateState("featureKey", featureKey);
              highlightFeature(e);
            } else {
              // second click in a row deselects this feature
              updateState("featureKey", null);
            }
          },
        });
      });

      const opacityControl = L.control.opacity(
        { "<div class='opacity-control-label'>Layer Opacity</div>" : state.layer },
        {
          position: "bottomright",
          initialOpacity: state.opacity,
          updateOpacity: (layer, opacity) => updateState("opacity", opacity),
        },
      );

      const timelineControl = L.control.timelineSlider({
        position: "bottomright",
        timelineItems: state.years,
        changeMap: function({label, index, map}) {
          updateState("year", label);
        }
      });

      /* This control is based on https://github.com/cw353/hei-map-project/blob/main/code/map/map_controls.js (MIT License) */
      const geocoderControl = L.Control.geocoder({
        placeholder: "Search for a location...",
        errorMessage: "No results found.",
        showUniqueResult: false,
        defaultMarkGeocode: false,
        position: "topright",
        collapsed: false,
      }).on("markgeocode", function(e) {
        if (e.geocode && e.geocode.center) {
          map.setView(e.geocode.center, map.getMaxZoom());
          const div = L.DomUtil.create("div", "center");
          div.innerHTML = e.geocode.html;
          L.popup().setLatLng(e.geocode.center).setContent(div).openOn(map);
        }
      });
      
      // add controls in order, proceeding clockwise from bottom left to bottom right
      // note that adding timelineSlider updates state.year and thus initializes the rest of the map
      legend.addTo(map); // bottomleft
      L.control.defaultExtent({position: "topleft"}).addTo(map); // topleft
      info.addTo(map); // topleft
      dataSelectControl.addTo(map); // topright
      graphControl.addTo(map); // topright
      geocoderControl.addTo(map); // topright
      timelineControl.addTo(map); // bottomright
      opacityControl.addTo(map); // bottomright
      L.control.resizer({ direction: 'se' }).addTo(map); // bottomright

      // disable event propagation for geocoder control
      L.DomEvent.disableClickPropagation(geocoderControl._container);
      L.DomEvent.disableScrollPropagation(geocoderControl._container);

    </script>

</body>
</html>
