<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cook County Sales Choropleth Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"></script>
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

  <!-- leaflet-chloropleth and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js" integrity="sha512-zInFF17qBFVvvvFpIfeBzo7Tj7+rQxLeTJDmbxjBz5/zIr89YVbTNelNhdTT+/DCrxoVzBeUPVFJsczKbB7sew==" crossorigin="anonymous"></script>
  <script src="plugins/choropleth.js"></script>

  <!-- other Leaflet plugins -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.control.layers.tree@1.1.0/L.Control.Layers.Tree.css" integrity="sha512-ERJ24eirtxblVa8OFgLvEo5POXA4KjIH9dFD1RjXL0FbTr5PkpBYTnIMFGhhWdmGdXOUlxQhLu/S0BiPsbjAIA==" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet.control.layers.tree@1.1.0/L.Control.Layers.Tree.js" integrity="sha512-ETs9/6gyO86T5BWV+frzCctOVKzUa8CalhT+rCnm0AARnAAMX72vS6ifbFaeZr7BdxogolRqCS99XPbF2ltaqg==" crossorigin="anonymous"></script>  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-groupedlayercontrol@0.6.1/dist/leaflet.groupedlayercontrol.min.css" integrity="sha512-yP7tTm3rX87fOK3iDh9K2RJTHsq6BfGZ8sFqRMIfsmmZVakOw483WyOKlRWVLjHCHEDIcEkp/U+cO3TnZ8oiuw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.defaultextent@0.0.3/dist/leaflet.defaultextent.css" integrity="sha512-ov430Sdjmh6nk7i0pfdpzBiSi7KFhMC5oiO5eEB7YmzcmPCLJySjYdKu4DCRMVLsEGfP9eGx7NRyLgqykhuruA==" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet.defaultextent@0.0.3/dist/leaflet.defaultextent.js" integrity="sha512-msnSqRmMNIELIn0wnF4k9rY12rzfwi4Ak0CWgx0xr4WPF5x/oUMNV+m+/2UWJSobC5zKqngmtBeuCtcUxkeSlQ==" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.24.3/dist/plotly-basic.min.js" integrity="sha512-Qim/xu0OSUPEvOUcNVZoGTDa+m4Ll1EZ+DQhsmMTlMZIj7NxvwQl6pGY0/gwlj19w0KEZ0S8ymSWUpqarPYGBQ==" crossorigin="anonymous"></script>
  <script src="plugins/leaflet-timeline-slider.min.js"></script>
  <script src="plugins/L.Control.Opacity/L.Control.Opacity.js"></script>

  <!-- data -->
  <script src="data/sales.js"></script>
  <script src="data/neighborhoods.js"></script>
  
  <style type="text/css">
    #map {
      height: 600px;
    }
    .italic {
      font-style: italic;
    }
    .leaflet-control {
      background: rgba(255,255,255,0.8);
    }
    a, a.external {
      color: #36c;
    }
    a.external::after {
      /* Source: Wikimedia Commons, https://commons.wikimedia.org/wiki/File:Link-external-small-ltr-progressive.svg (CC BY 4.0) */
      content: url(https://upload.wikimedia.org/wikipedia/commons/9/96/Link-external-small-ltr-progressive.svg);
      margin: 0px 0px 0px 5px;
    }
    label {
      margin-right: 5px;
    }
    .info {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
    }
    .info h4, .opacity-control-label {
      margin: 0 0 5px;
      color: #777;
      text-align: center;
    }
    .info p {
      text-align: center;
    }
    .legend {
      line-height: 18px;
      color: #555;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
      border-left: 1px solid black;
      border-right: 1px solid black;
    }
    .legend i:first-of-type {
      border-top: 1px solid black;
    }
    .legend br:first-of-type {
      line-height: 19px;
    }
    .legend i:last-of-type {
      border-bottom: 1px solid black;
    }
    .opacity-control-label {
      font: 14px/16px Arial, Helvetica, sans-serif;
      font-weight: bold;
    }
    .show-all-link {
      font-style: italic;
      cursor: pointer;
    }
    .data-select {
      line-height: 2em;
    }
  </style>

</head>
<body>
    <div id="map"></div>

    <script>
      /*
       * references for code and styling:
       * https://github.com/timwis/leaflet-choropleth/blob/gh-pages/examples/fetch_join/demo.js (MIT license)
       * https://leafletjs.com/examples/choropleth/ (BSD 2-Clause "Simplified" License)
       */

      const map = new L.Map('map', {
        center: { lat: 41.75736, lng: -87.67518 },
        zoom: 9.5,
        zoomDelta: 0.5,
        zoomSnap: 0.5,
      });

      const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "<a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>",
      }).addTo(map);
      
      const usd_formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0,
      });
      const count_formatter = new Intl.NumberFormat('en-US');

      const numeric_value = function(value) {
        const parsed = parseFloat(value);
        return parsed;
      }
      const numeric_display = function(value, formatter) {
        return value ? formatter.format(value) : "unknown";
      }

      class Feature {
        constructor(label, get_value, display, d3_format) {
          this.label = label;
          this.get_value = get_value;
          this.display = display;
          this.d3_format = d3_format;
        }
        getLabel() {
          return this.label;
        }
        getValue(val) {
          return this.get_value(val);
        }
        getD3Format() {
          return this.d3_format;
        }
        display(val) {
          return this.get_display(val);
        }
      }
      class USDFeature extends Feature {
        constructor(label) {
          super(label, numeric_value, (val) => numeric_display(val, usd_formatter), ":$,");
        }
      }
      class CountFeature extends Feature {
        constructor(label) {
          super(label, numeric_value, (val) => numeric_display(val, count_formatter), ":,");
        }
      }

      function getValue(props, data) {
        const key = props.nbhd_code;
        const val = data[key] && data[key][state.year] ? data[key][state.year][state.attribute] : null;
        return state._attributeProps.getValue ? state._attributeProps.getValue(val) : val;
      }

      // Get colors and limits for a choropleth map
      function getChoroplethProps(layer, data, getValue, options = null) {
        // overwrite default options with provided options (if any)
        const opts = Object.assign({
          mode: 'q', steps: 10, scale: 'viridis'
        }, options);
        const values = [];
        layer.eachLayer(function(sublayer) {
          values.push(getValue(sublayer.feature.properties, data));
        });
        const limits = chroma.limits(values, opts.mode, opts.steps);
        const colors = opts.colors && opts.colors.length === limits.length
          ? opts.colors
          : chroma.scale(opts.scale).colors(limits.length-1);
        return [limits, colors];
      }

      const saleAttributes = {
        "mean": new USDFeature("Average Sale Price"),
        "median": new USDFeature("Median Sale Price"),
        "count": new CountFeature("Number of Sales"),
      };

      const info = L.control({position: "topleft"});
      info.onAdd = function(map) {
        this._div = L.DomUtil.create("div", "info");
        return this._div;
      };
      info.update = function() {
        // Add header
        this._div.innerHTML = state.key == null ? "<h4>Summary of<br>All Assessor Neighborhoods</h4>" : `<h4>Details for<br>Assessor Neighborhood ${state.key}</h4>`;
        // Add data items
        const data = state.key == null ? state.summaryData : state.choroplethData[state.key];
        const items = [`<b>Year</b>: ${state.year}`];
        for (const attribute in saleAttributes) {
          const attributeProps = saleAttributes[attribute];
          items.push(`<b>${attributeProps.getLabel()}</b>: ${attributeProps.display(data && data[state.year] ? data[state.year][attribute] : null)}`);
        }
        this._div.innerHTML += items.join("<br>");
        // Add link to source data
        let query = `https://datacatalog.cookcountyil.gov/resource/wvhk-k5uv.json?$where=starts_with(class, '2') AND year=${state.year}`;
        if (state.key != null) {
          query += ` AND nbhd_code='${state.key}'`;
        }
        query += "&$limit=1000000000";
        this._div.innerHTML += `<p><a class='external' href="${query}">View source data</a></p>`;
        // Add info about how to toggle view between summary of all areas and details of specific area
        if (state.key == null) {
          this._div.innerHTML += "<p class='italic'>Click on an area to see details.</p>";
        } else {
          this._div.innerHTML += "<p class='italic'>Click on this area again to deselect it.</p>"
        }
      };

      const dataSelectControl = L.control({position: "topright"});
      dataSelectControl.onAdd = function(map) {
        this._div = L.DomUtil.create("div", "info data-select");
        // prevent clicks from propagating to map below
        L.DomEvent.on(this._div, "click", function(e) { L.DomEvent.stopPropagation(e); });
        // TODO: add ability to select different property classes using event handler on this._selectClass?
        const selectClass = $("<select id='select-class'></select>")
          .html("<option value='class2'>Major Class 2 (Residential, Non-Multi-Family)</option>");
        const selectAttribute = $("<select id='select-attr'></select>")
          .html(Object.entries(saleAttributes).map(function([attribute, attributeProps]) {
            return `<option value="${attribute}">${attributeProps.getLabel()}</option>`;
          }))
          .on("change", function(e) {
            updateState("attribute", e.target.value);
          });
        $(this._div).append([
          $("<div class='data-select-div'></div>").append([
            `<label for="select-attr">Select Property Class:</label>`,
            selectClass,
          ]),
          $("<div data-select-div></div>").append([
            `<label for="select-attr">Select Attribute:</label>`,
            selectAttribute,
          ]),
        ]);
        return this._div;
      }

      const legend = L.control({position: "bottomleft"});
      legend.onAdd = function(map) {
        this._div = L.DomUtil.create("div", "info legend");
        return this._div;
      }
      legend.update = function(colors = null, labels = null, title = "Legend") {
        if (colors == null || labels == null || colors.length !== labels.length) {
          this._div.innerHTML = "";
        } else {
          this._div.innerHTML = `<h4>${title}</h4>`;
          for (let i = 0; i < colors.length; i++) {
            this._div.innerHTML += `<i style="background: ${colors[i]}"></i> ${labels[i]}<br>`;
          }
        }
      };

      const state = {
        layer: null,
        year: null,
        key: null,
        attribute: "mean",
        _attributeProps: saleAttributes["mean"],
        choroplethData: sales_by_nbhd,
        summaryData: sales_totals,
        years: sales_years,
        _limits: null,
        _colors: null,
        fillOpacity: 0.7,
      };
      const updateChoropleth = function() {
        // TODO: add caching for limits and colors?
        [state._limits, state._colors] = getChoroplethProps(state.layer, state.choroplethData, getValue);
        // update fill colors on map
        state.layer.setStyle(function(feature) {
          const val = getValue(feature.properties, state.choroplethData);
          let fillColor = null;
          if (val != null && !isNaN(val)) {
            for (let i = 0; i < state._limits.length-1; i++) {
              if (val <= state._limits[i+1]) {
                fillColor = state._colors[i];
                break;
              }
            }
          }
          return { fillColor: fillColor };
        });
        // update legend
        const display_func = null;
        const labels = ["unknown"];
        for (let i = 0; i < state._colors.length; i++) {
          const lower_limit = i === 0 ? Math.trunc(state._limits[i]) : Math.trunc(state._limits[i]+1);
          const upper_limit = Math.trunc(state._limits[i+1]);
          const label = state._attributeProps.display(lower_limit) + " &ndash; " + state._attributeProps.display(upper_limit);
          labels.push(label);
        }
        legend.update([null].concat(state._colors), labels, state._attributeProps.getLabel());
      }

      // callbacks to be called when the corresponding prop in state is changed
      const stateCallbacks = {
        year: function(val) {
          updateChoropleth();
          info.update();
        },
        attribute: function(val) {
          state._attributeProps = saleAttributes[val];
          updateChoropleth();
          info.update();
        },
        key: function(val) {
          info.update();
        },
        fillOpacity: function(val) { state.layer.setStyle( { fillOpacity: val } ); },
      }

      function updateState(prop, val) {
        state[prop] = val;
        // if a state callback for this prop exists, call it
        if (prop in stateCallbacks) {
          stateCallbacks[prop](val);
        }
      }

      function highlightFeature(e) {
        e.target.setStyle({
          weight: 5,
          color: '#333',
        }).bringToFront();
      }

      const defaultStyle = {
        color: '#fff',
        weight: 2,
      };
      state.layer = L.geoJSON(
        neighborhoods,
        {
          attribution: "<a href='https://datacatalog.cookcountyil.gov/d/wvhk-k5uv'>Cook County Assessor's Office</a>",
          style: Object.assign({fillOpacity: state.fillOpacity}, defaultStyle),
        }
      ).addTo(map);
      state.layer.eachLayer(function (sublayer) {
        sublayer.on({
          click: function(e) {
            state.layer.setStyle(defaultStyle);
            const key = sublayer.feature.properties.nbhd_code;
            if (state.key !== key) {
              // first click in a row selects this feature
              updateState("key", key);
              highlightFeature(e);
            } else {
              // second click in a row deselects this feature
              updateState("key", null);
            }
            console.log(state.key);
          },
        });
      });

      const opacityControl = L.control.opacity(
        { "<div class='opacity-control-label'>Layer Opacity</div>" : state.layer },
        {
          position: "bottomleft",
          initialOpacity: state.fillOpacity,
          updateOpacity: (layer, opacity) => updateState("fillOpacity", opacity),
        },
      );

      const timelineControl = L.control.timelineSlider({
        position: "bottomright",
        timelineItems: state.years,
        changeMap: function({label, index, map}) {
          updateState("year", label);
        }
      });
      
      // add controls in order, proceeding clockwise from bottom left to bottom right
      opacityControl.addTo(map); // bottomleft
      legend.addTo(map); // bottomleft
      info.addTo(map); // topleft
      dataSelectControl.addTo(map); // topright
      timelineControl.addTo(map); // bottomright

    </script>

</body>
</html>
